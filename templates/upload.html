{% extends "base.html" %}
{% block title %}Upload — Baby Jukebox{% endblock %}

{% block content %}
<div class="space-y-8">

  <h1 class="text-2xl font-bold text-white">Importer des fichiers audio</h1>

  <!-- Zone de drag & drop -->
  <div id="drop-zone"
       class="border-2 border-dashed border-gray-600 rounded-2xl p-10 text-center
              transition hover:border-brand hover:bg-gray-900/50 cursor-pointer">
    <form id="upload-form" method="post" enctype="multipart/form-data" action="{{ url_for('upload') }}">
      <input id="file-input" type="file" name="files" multiple accept=".mp3,.ogg,.wav,.flac,.m4a"
             class="hidden" />
      <label for="file-input" class="cursor-pointer">
        <svg class="w-14 h-14 mx-auto text-gray-600 mb-4" fill="none" stroke="currentColor"
             stroke-width="1.5" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="M9 9l3-3m0 0l3 3m-3-3v12M5.25 20.25h13.5"/>
        </svg>
        <p class="text-lg font-medium text-gray-300">Glissez vos fichiers ici</p>
        <p class="text-sm text-gray-500 mt-1">ou cliquez pour parcourir (MP3, OGG, WAV, FLAC, M4A — max 100 Mo)</p>
      </label>
      <div id="file-list" class="mt-4 text-sm text-gray-400 space-y-1"></div>
      <button type="submit"
              class="mt-6 hidden px-6 py-2 bg-brand hover:bg-brand-dark rounded-xl text-white font-medium transition"
              id="submit-btn">
        Uploader
      </button>
    </form>
  </div>

  <!-- Section YouTube -->
  <div class="bg-gray-900 rounded-2xl p-6 space-y-4">
    <h2 class="text-lg font-semibold text-gray-200 flex items-center gap-2">
      <svg class="w-5 h-5 text-red-500 shrink-0" fill="currentColor" viewBox="0 0 24 24">
        <path d="M23.5 6.2a3 3 0 0 0-2.1-2.1C19.5 3.5 12 3.5 12 3.5s-7.5 0-9.4.6A3 3 0 0 0 .5 6.2 31 31 0 0 0 0 12a31 31 0 0 0 .5 5.8 3 3 0 0 0 2.1 2.1c1.9.6 9.4.6 9.4.6s7.5 0 9.4-.6a3 3 0 0 0 2.1-2.1A31 31 0 0 0 24 12a31 31 0 0 0-.5-5.8ZM9.75 15.5v-7l6.25 3.5-6.25 3.5Z"/>
      </svg>
      Télécharger depuis YouTube
    </h2>

    <!-- Barre de recherche -->
    <div class="flex gap-2">
      <input id="yt-search-input" type="text" placeholder="Titre, artiste, album…"
             class="flex-1 bg-gray-800 border border-gray-700 rounded-xl px-4 py-2 text-white
                    placeholder-gray-500 focus:outline-none focus:border-brand transition text-sm"
             onkeydown="if(event.key==='Enter') searchYoutube()" />
      <button onclick="searchYoutube()"
              class="px-4 py-2 bg-brand hover:bg-brand-dark rounded-xl text-white text-sm font-medium transition shrink-0">
        Rechercher
      </button>
    </div>

    <!-- Résultats de recherche -->
    <div id="yt-results" class="space-y-2"></div>

    <!-- Séparateur + URL directe -->
    <div class="border-t border-gray-800 pt-4">
      <p class="text-xs text-gray-500 mb-2">Ou collez une URL YouTube directement :</p>
      <div class="flex gap-2">
        <input id="yt-url-input" type="text" placeholder="https://www.youtube.com/watch?v=…"
               class="flex-1 bg-gray-800 border border-gray-700 rounded-xl px-4 py-2 text-white
                      placeholder-gray-500 focus:outline-none focus:border-brand transition text-sm" />
        <button onclick="downloadFromUrl()"
                class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-xl text-white text-sm font-medium transition shrink-0">
          ↓ Télécharger
        </button>
      </div>
    </div>
  </div>

  <!-- Liste des audios existants -->
  <div>
    <h2 class="text-lg font-semibold text-gray-200 mb-3">
      Bibliothèque
      <span class="text-sm font-normal text-gray-500">({{ audios|length }} fichier(s))</span>
    </h2>

    {% if audios %}
    <ul class="space-y-2">
      {% for audio in audios %}
      <li class="flex items-center gap-3 bg-gray-900 rounded-xl px-4 py-3">
        <!-- Icône note musicale -->
        <svg class="w-5 h-5 text-brand-light shrink-0" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 3v10.55A4 4 0 1 0 14 17V7h4V3h-6Z"/>
        </svg>
        <span class="flex-1 truncate text-sm text-gray-200">{{ audio.name }}</span>
        <span class="text-xs text-gray-500 hidden sm:block">{{ audio.file_path.split('/')[-1] }}</span>
        <!-- Bouton play -->
        <form method="post" action="{{ url_for('play_audio', audio_id=audio.id) }}">
          <button type="submit"
                  class="text-green-400 hover:text-green-300 transition p-1" title="Lire">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
              <path d="M8 5v14l11-7z"/>
            </svg>
          </button>
        </form>
        <!-- Bouton supprimer -->
        <form method="post" action="{{ url_for('delete_audio', audio_id=audio.id) }}"
              onsubmit="return confirm('Supprimer « {{ audio.name }} » ?')">
          <button type="submit"
                  class="text-red-500 hover:text-red-400 transition p-1" title="Supprimer">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
              <path d="M6 19a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7H6v12ZM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4Z"/>
            </svg>
          </button>
        </form>
      </li>
      {% endfor %}
    </ul>
    {% else %}
    <p class="text-gray-500 text-sm">Aucun fichier importé pour l'instant.</p>
    {% endif %}
  </div>
</div>

<script>
  // ---------------------------------------------------------------------------
  // YouTube
  // ---------------------------------------------------------------------------

  function escHtml(s) {
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function showToast(msg, type = 'success') {
    const t = document.createElement('div');
    t.className = `fixed bottom-6 right-6 z-50 px-5 py-3 rounded-xl text-white text-sm font-medium shadow-xl transition
                   ${type === 'success' ? 'bg-green-700' : 'bg-red-700'}`;
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 4000);
  }

  async function searchYoutube() {
    const q = document.getElementById('yt-search-input').value.trim();
    if (!q) return;

    const resultsEl = document.getElementById('yt-results');
    resultsEl.innerHTML = '<p class="text-gray-500 text-sm animate-pulse">Recherche en cours…</p>';

    try {
      const res = await fetch('/api/youtube/search?q=' + encodeURIComponent(q));
      const data = await res.json();

      if (data.error) {
        resultsEl.innerHTML = `<p class="text-red-400 text-sm">Erreur : ${escHtml(data.error)}</p>`;
        return;
      }
      if (!data.results.length) {
        resultsEl.innerHTML = '<p class="text-gray-500 text-sm">Aucun résultat.</p>';
        return;
      }

      resultsEl.innerHTML = data.results.map(r => `
        <div class="flex items-center gap-3 bg-gray-800 rounded-xl p-3">
          <img src="${r.thumbnail}" alt=""
               class="w-24 h-16 object-cover rounded-lg shrink-0 bg-gray-700"
               loading="lazy" onerror="this.style.display='none'" />
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-white truncate" title="${escHtml(r.title)}">${escHtml(r.title)}</p>
            <p class="text-xs text-gray-400 mt-0.5">${escHtml(r.uploader)} · ${r.duration}</p>
          </div>
          <button id="btn-${r.id}"
                  onclick="startDownload('${escHtml(r.url)}', '${r.id}')"
                  class="shrink-0 px-3 py-1.5 bg-brand hover:bg-brand-dark text-white text-xs
                         font-medium rounded-lg transition whitespace-nowrap">
            ↓ Télécharger
          </button>
        </div>
      `).join('');
    } catch (e) {
      resultsEl.innerHTML = `<p class="text-red-400 text-sm">Erreur réseau : ${escHtml(e.message)}</p>`;
    }
  }

  async function downloadFromUrl() {
    const url = document.getElementById('yt-url-input').value.trim();
    if (!url) return;
    const btn = document.querySelector('#yt-url-input + button') ||
                document.querySelector('[onclick="downloadFromUrl()"]');
    await startDownload(url, null, btn);
  }

  async function startDownload(url, videoId, btnOverride) {
    const btn = btnOverride || (videoId ? document.getElementById('btn-' + videoId) : null);
    if (btn) { btn.disabled = true; btn.textContent = '…'; }

    try {
      const fd = new FormData();
      fd.append('url', url);
      const res = await fetch('/youtube/download', { method: 'POST', body: fd });
      const { job_id, error } = await res.json();

      if (error) {
        if (btn) { btn.textContent = '✗ Erreur'; btn.disabled = false; }
        showToast('Erreur : ' + error, 'error');
        return;
      }

      // Polling jusqu'à fin du téléchargement
      const iv = setInterval(async () => {
        try {
          const r = await fetch('/api/youtube/status/' + job_id);
          const data = await r.json();

          if (data.status === 'done') {
            clearInterval(iv);
            if (btn) {
              btn.textContent = '✓ Importé';
              btn.classList.replace('bg-brand', 'bg-green-700');
              btn.classList.replace('hover:bg-brand-dark', 'hover:bg-green-800');
            }
            showToast('Téléchargé : ' + data.audio_name);
          } else if (data.status === 'error') {
            clearInterval(iv);
            if (btn) { btn.textContent = '✗ Erreur'; btn.disabled = false; }
            showToast('Erreur : ' + data.message, 'error');
          }
        } catch (_) { /* réseau temporairement indisponible, on réessaie */ }
      }, 1500);

    } catch (e) {
      if (btn) { btn.textContent = '✗ Erreur'; btn.disabled = false; }
      showToast('Erreur réseau : ' + e.message, 'error');
    }
  }

  // ---------------------------------------------------------------------------
  // Upload fichiers
  // ---------------------------------------------------------------------------

  const input = document.getElementById('file-input');
  const fileList = document.getElementById('file-list');
  const submitBtn = document.getElementById('submit-btn');
  const dropZone = document.getElementById('drop-zone');

  function updateList(files) {
    fileList.innerHTML = '';
    if (files.length === 0) { submitBtn.classList.add('hidden'); return; }
    for (const f of files) {
      const el = document.createElement('p');
      el.textContent = `• ${f.name} (${(f.size / 1024 / 1024).toFixed(2)} Mo)`;
      fileList.appendChild(el);
    }
    submitBtn.classList.remove('hidden');
  }

  input.addEventListener('change', () => updateList(input.files));

  // Drag & drop
  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('border-brand', 'bg-gray-900/50');
  });
  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('border-brand', 'bg-gray-900/50');
  });
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-brand', 'bg-gray-900/50');
    const dt = new DataTransfer();
    for (const f of e.dataTransfer.files) dt.items.add(f);
    input.files = dt.files;
    updateList(input.files);
  });
</script>
{% endblock %}
